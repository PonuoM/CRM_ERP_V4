# ‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö" (Reconciliation)

## üéØ ‡∏à‡∏∏‡∏î‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå

‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö (Reconciliation) ‡∏Ñ‡∏∑‡∏≠‡∏Å‡∏≤‡∏£ **‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà Statement (‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏à‡∏≤‡∏Å‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£) ‡∏Å‡∏±‡∏ö Order (‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠)** ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ß‡πà‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏£‡∏¥‡∏á‡πÜ

## üìã ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô (‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö")

### 1. **‡∏™‡∏£‡πâ‡∏≤‡∏á Batch (‡∏ä‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö)**
   - ‡∏™‡∏£‡πâ‡∏≤‡∏á `statement_reconcile_batches` ‡πÉ‡∏´‡∏°‡πà
   - ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£, ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£, ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô-‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î, ‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
   - ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£: `KBANK-20250201-001`

### 2. **‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞ Statement ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å:**

   #### 2.1 ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
   - ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ Statement ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô company ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
   - ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ Statement ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å reconcile ‡∏ã‡πâ‡∏≥
   - ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ Order ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏£‡∏¥‡∏á ‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡πá‡∏ô Transfer order
   - ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ Order ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô company ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á

   #### 2.2 ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô
   - ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà reconcile ‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏Ç‡∏≠‡∏á Order
   - ‚úÖ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà reconcile ‡πÅ‡∏•‡πâ‡∏ß (‡∏à‡∏≤‡∏Å batch ‡∏≠‡∏∑‡πà‡∏ô‡πÜ)
   - ‚úÖ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠

   #### 2.3 ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Reconciliation Log
   - ‡∏™‡∏£‡πâ‡∏≤‡∏á `statement_reconcile_logs` ‡πÉ‡∏´‡∏°‡πà
   - ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: Statement ID, Order ID, ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô, ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô

   #### 2.4 ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó Order
   - **‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó `amount_paid`** = ‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà reconcile ‡πÅ‡∏•‡πâ‡∏ß‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
   - **‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó `payment_status`**:
     - ‡∏ñ‡πâ‡∏≤ `amount_paid >= total_amount` ‚Üí `"Approved"` ‡∏´‡∏£‡∏∑‡∏≠ `"Paid"`
     - ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö ‚Üí `"PreApproved"`
   - **‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó `order_status`**:
     - ‡∏ñ‡πâ‡∏≤ Order ‡∏¢‡∏±‡∏á‡πÄ‡∏õ‡πá‡∏ô `Pending`, `AwaitingVerification`, `Confirmed` ‚Üí ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô `"Preparing"`
     - ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô status ‡∏≠‡∏∑‡πà‡∏ô ‚Üí ‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°

### 3. **Commit Transaction**
   - ‡∏ñ‡πâ‡∏≤‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚Üí Commit (‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ñ‡∏≤‡∏ß‡∏£)
   - ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ error ‚Üí Rollback (‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)

## üîç ‡∏ó‡∏≥‡πÑ‡∏°‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÄ‡∏¢‡∏≠‡∏∞?

### ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏û‡∏ö:

1. **Collation Mismatch** ‚ö†Ô∏è
   - ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö string ‡∏ó‡∏µ‡πà‡∏°‡∏µ collation ‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô
   - `orders.id` (utf8mb4_unicode_ci) vs parameter (utf8mb4_0900_ai_ci)
   - ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏î‡∏¢: ‡πÄ‡∏û‡∏¥‡πà‡∏° COLLATE clause ‡πÅ‡∏•‡∏∞ CAST

2. **Foreign Key Constraints**
   - `statement_reconcile_logs.order_id` ‚Üí `orders.id`
   - ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ collation ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô
   - ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏î‡∏¢: ‡πÅ‡∏õ‡∏•‡∏á collation ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô

3. **Transaction Complexity**
   - ‡∏°‡∏µ‡∏´‡∏•‡∏≤‡∏¢ operations ‡πÉ‡∏ô transaction ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
   - ‡∏ñ‡πâ‡∏≤ error ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô ‚Üí rollback ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
   - ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ó‡∏∏‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô

## üìä ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô

### ‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå:
- Order #ORD-001: ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° 10,000 ‡∏ö‡∏≤‡∏ó
- Statement #ST-001: ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô 5,000 ‡∏ö‡∏≤‡∏ó
- Statement #ST-002: ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô 5,000 ‡∏ö‡∏≤‡∏ó

### ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å:
1. **Statement #ST-001** ‚Üí Order #ORD-001 (5,000 ‡∏ö‡∏≤‡∏ó)
   - `amount_paid` = 5,000
   - `payment_status` = "PreApproved"
   - `order_status` = "Preparing"

2. **Statement #ST-002** ‚Üí Order #ORD-001 (5,000 ‡∏ö‡∏≤‡∏ó)
   - `amount_paid` = 10,000 (5,000 + 5,000)
   - `payment_status` = "Approved" (‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß)
   - `order_status` = "Preparing"

## ‚úÖ ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á

‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:
- ‚úÖ ‡∏°‡∏µ `statement_reconcile_batches` ‡πÉ‡∏´‡∏°‡πà 1 record
- ‚úÖ ‡∏°‡∏µ `statement_reconcile_logs` ‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô statements ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
- ‚úÖ Orders ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏ñ‡∏π‡∏Å‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó:
  - `amount_paid` ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô
  - `payment_status` ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ï‡∏≤‡∏°‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢
  - `order_status` ‡∏≠‡∏≤‡∏à‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô "Preparing"

## üõ†Ô∏è ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß

1. ‚úÖ ‡πÅ‡∏õ‡∏•‡∏á collation ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏õ‡πá‡∏ô `utf8mb4_unicode_ci`
2. ‚úÖ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ connection collation ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
3. ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° COLLATE clause ‡πÉ‡∏ô‡∏ó‡∏∏‡∏Å string comparison
4. ‚úÖ ‡πÉ‡∏ä‡πâ CAST ‡πÉ‡∏ô INSERT statements
5. ‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç orphaned references

## üí° ‡∏™‡∏£‡∏∏‡∏õ

**‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö = ‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ß‡πà‡∏≤ Statement (‡πÄ‡∏á‡∏¥‡∏ô‡πÇ‡∏≠‡∏ô) ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö Order (‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠)**

- ‡∏ñ‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚Üí Order ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏ß‡πà‡∏≤‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß
- ‡∏ñ‡πâ‡∏≤ error ‚Üí ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡πÉ‡∏î‡πÜ (rollback)

‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏û‡∏ö‡∏™‡πà‡∏ß‡∏ô‡πÉ‡∏´‡∏ç‡πà‡∏°‡∏≤‡∏à‡∏≤‡∏Å **collation mismatch** ‡∏ã‡∏∂‡πà‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß!

