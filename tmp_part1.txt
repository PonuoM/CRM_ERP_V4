export type LoginResponse = {
  ok: boolean;
  user?: {
    id: number;
    username: string;
    first_name: string;
    last_name: string;
    email?: string;
    phone?: string;
    role: string;
    company_id: number;
    team_id?: number;
    supervisor_id?: number;
  };
  error?: string;
};

const base = 'api/index.php/'; // works with or without Apache rewrite

export async function apiFetch(path: string, init?: RequestInit) {
  const res = await fetch(`${base}${path}`, {
    headers: { 'Content-Type': 'application/json', ...(init?.headers || {}) },
    ...init,
  });

  const text = await res.text();
  let data: any = null;
  try {
    data = text ? JSON.parse(text) : null;
  } catch {
    data = null; // non-JSON response
  }

  if (!res.ok) {
    const errMsg = (data && (data.message || data.error)) || res.statusText || 'API error';
    const err = new Error(`API ${res.status}: ${errMsg}`);
    (err as any).status = res.status;
    (err as any).data = data ?? text;
    throw err;
  }
  return data;
}

export async function health(): Promise<{ ok: boolean; status: string }> {
  return apiFetch('health');
}

export async function login(username: string, password: string): Promise<LoginResponse> {
  return apiFetch('auth/login', {
    method: 'POST',
    body: JSON.stringify({ username, password }),
  });
}

// Attendance APIs
export async function listAttendance(params: { userId?: number; date?: string; start?: string; end?: string; roleOnly?: 'telesale'|'all'; kpis?: boolean; companyId?: number }) {
  const qs = new URLSearchParams();
  if (params.userId) qs.set('userId', String(params.userId));
  if (params.date) qs.set('date', params.date);
  if (params.start) qs.set('start', params.start);
  if (params.end) qs.set('end', params.end);
  if (params.roleOnly) qs.set('roleOnly', params.roleOnly);
  if (params.companyId) qs.set('companyId', String(params.companyId));
  const path = params.kpis ? 'attendance/kpis' : 'attendance';
  return apiFetch(`${path}${qs.toString() ? `?${qs}` : ''}`);
}

export async function checkInAttendance(userId: number) {
  return apiFetch('attendance/check_in', { method: 'POST', body: JSON.stringify({ userId }) });
}

export async function listCustomers(params?: { q?: string; companyId?: number; bucket?: string; userId?: number }) {
  const qs = new URLSearchParams();
  if (params?.q) qs.set('q', params.q);
  if (params?.companyId) qs.set('companyId', String(params.companyId));
  if (params?.bucket) qs.set('bucket', params.bucket);
  if (params?.userId) qs.set('userId', String(params.userId));
  const query = qs.toString();
  return apiFetch(`customers${query ? `?${query}` : ''}`);
}

export async function listUsers() {
  return apiFetch('users');
}

export async function createUser(payload: {
  username: string;
  password: string;
  firstName: string;
  lastName: string;
  email?: string;
  phone?: string;
  role: string;
  companyId: number;
  teamId?: number;
  supervisorId?: number;
}) {
  return apiFetch('users', { method: 'POST', body: JSON.stringify(payload) });
}

export async function updateUser(id: number, payload: Partial<{
  username: string;
  password: string;
  firstName: string;
  lastName: string;
  email?: string;
  phone?: string;
  role: string;
  companyId: number;
  teamId?: number;
  supervisorId?: number;
}>) {
  return apiFetch(`users/${encodeURIComponent(String(id))}`, { method: 'PATCH', body: JSON.stringify(payload) });
}

export async function deleteUser(id: number) {
  return apiFetch(`users/${encodeURIComponent(String(id))}`, { method: 'DELETE' });
}

export async function listProducts() {
  return apiFetch('products');
}

export async function createProduct(payload: any) {
  return apiFetch('products', { method: 'POST', body: JSON.stringify(payload) });
}

export async function updateProduct(id: number, payload: any) {
  return apiFetch(`products/${encodeURIComponent(String(id))}`, { method: 'PATCH', body: JSON.stringify(payload) });
}

export async function deleteProduct(id: number) {
  return apiFetch(`products/${encodeURIComponent(String(id))}`, { method: 'DELETE' });
}

export async function listPromotions() {
  return apiFetch('promotions');
}

export async function createPromotion(promotionData: any) {
  return apiFetch('promotions', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify(promotionData)
  });
}

export async function updatePromotion(id: number, promotionData: any) {
  return apiFetch(`promotions/${id}`, {
    method: 'PUT',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify(promotionData)
  });
}

export async function deletePromotion(id: number) {
  return apiFetch(`promotions/${id}`, {
    method: 'DELETE'
  });
}

export async function listPages(companyId?: number) {
  const qs = new URLSearchParams();
  if (companyId) qs.set('companyId', String(companyId));
  return apiFetch(`pages${companyId ? `?${qs}` : ''}`);
}

export async function createPage(payload: { name: string; platform?: string; url?: string; companyId: number; active?: boolean; }) {
  return apiFetch('pages', { method: 'POST', body: JSON.stringify(payload) });
}

export async function updatePage(id: number, payload: Partial<{ name: string; platform: string; url?: string; companyId: number; active: boolean; }>) {
  return apiFetch(`pages/${encodeURIComponent(String(id))}`, { method: 'PATCH', body: JSON.stringify(payload) });
}

export async function listOrders() {
  return apiFetch('orders');
}

export async function listAppointments(customerId?: string) {
  const qs = new URLSearchParams();
  if (customerId) qs.set('customerId', customerId);
  return apiFetch(`appointments${customerId ? `?${qs}` : ''}`);
}

export async function listCallHistory(customerId?: string) {
  const qs = new URLSearchParams();
  if (customerId) qs.set('customerId', customerId);
  return apiFetch(`call_history${customerId ? `?${qs}` : ''}`);
}

// Marketing: Ad spend
export async function listAdSpend(pageId?: number) {
  const qs = new URLSearchParams();
  if (pageId) qs.set('pageId', String(pageId));
  return apiFetch(`ad_spend${pageId ? `?${qs}` : ''}`);
}

export async function createAdSpend(payload: { pageId: number; date?: string; amount: number; notes?: string }) {
  return apiFetch('ad_spend', { method: 'POST', body: JSON.stringify(payload) });
}

// Mutations
export async function createCustomer(payload: any) {
  return apiFetch('customers', { method: 'POST', body: JSON.stringify(payload) });
}

export async function createOrder(payload: any) {
  return apiFetch('orders', { method: 'POST', body: JSON.stringify(payload) });
}

export async function patchOrder(id: string, payload: any) {
  return apiFetch(`orders/${encodeURIComponent(id)}`, { method: 'PATCH', body: JSON.stringify(payload) });
}

export async function updateCustomer(id: string, payload: any) {
