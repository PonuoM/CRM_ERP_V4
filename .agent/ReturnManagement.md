# กฎเกณฑ์และขั้นตอนการทำงานของระบบจัดการการตีกลับ (Return Management)

## 1. ภาพรวม
โมดูลจัดการการตีกลับ (Return Management) ออกแบบมาเพื่อติดตาม ตรวจสอบ และกระทบยอดคำสั่งซื้อที่ถูกตีกลับ โดยเปรียบเทียบข้อมูลในระบบ (คำสั่งซื้อที่มีสถานะ 'Returned') กับรายงานภายนอก (เช่น รายงานการตีกลับจากขนส่ง) เพื่อความถูกต้องทางบัญชีและสต็อกสินค้า

## 2. กฎเกณฑ์หลัก (Core Rules)

### 2.1 สิทธิ์ของคำสั่งซื้อที่นำมาตรวจสอบ
- **ข้อกำหนดสถานะ**: เฉพาะคำสั่งซื้อที่มี `order_status = 'Returned'` (สถานะเป็น "ตีกลับ") เท่านั้นที่จะถูกนำมาเข้าสู่กระบวนการตรวจสอบ
- **แหล่งข้อมูล**: ดึงข้อมูลจากตาราง `orders` หลักในระบบ

### 2.2 ข้อกำหนดของไฟล์นำเข้า (Import Requirements)
- **รูปแบบไฟล์**: Excel (`.xlsx`, `.xls`) หรือ CSV
- **คอลัมน์ที่จำเป็น**:
  - **ตัวระบุคำสั่งซื้อ**: อาจเป็นหมายเลข Tracking หรือ Order ID (ระบบจะพยายามตรวจหาคอลัมน์อัตโนมัติจากชื่อ เช่น `Order Number`, `Tracking`, `ID`)
  - **ยอดเงิน (Amount)**: ยอดเงิน COD หรือมูลค่าที่ขนส่งระบุว่าตีกลับ

### 2.3 ตรรกะการจับคู่ (Matching Logic)
ระบบจะพยายามจับคู่แต่ละแถวจากไฟล์ที่ Import กับคำสั่งซื้อในระบบ โดยใช้ลำดับความสำคัญดังนี้:
1. **จับคู่ด้วย Tracking Number**: ตรวจสอบว่าตัวระบุในไฟล์ตรงกับ `Tracking Number` ในระบบหรือไม่ (ทั้งจาก Tracking หลักและ Tracking ย่อยของแต่ละกล่อง)
2. **จับคู่ด้วย Order ID**: ตรวจสอบว่าตัวระบุในไฟล์ตรงกับ `Order ID` หรือไม่

### 2.4 สถานะการตรวจสอบ (Verification States)
| สถานะ | คำอธิบาย | การดำเนินการที่ต้องทำ |
| :--- | :--- | :--- |
| **Verified (ตรวจสอบแล้ว)** | พบคำสั่งซื้อ และ ยอดเงินตรงกัน (อนุโลมความต่างไม่เกิน 1.00 บาท) | ไม่ต้องทำอะไร (การตีกลับถูกต้อง) |
| **Amount Mismatch (ยอดไม่ตรง)** | พบคำสั่งซื้อ แต่ยอดเงินไม่ตรงกับในระบบ | ตรวจสอบสาเหตุ (เช่น คืนของไม่ครบ, การหักค่าธรรมเนียม, หรือข้อมูลผิดพลาด) |
| **Not Found (ไม่พบข้อมูล)** | ไม่พบคำสั่งซื้อที่มีสถานะ 'Returned' ที่ตรงกับข้อมูลในไฟล์ | ตรวจสอบว่าสถานะคำสั่งซื้อในระบบอัปเดตเป็น 'Returned' แล้วหรือไม่ หรือ Tracking Number ผิดพลาดหรือไม่ |

## 3. ขั้นตอนการทำงาน (Workflow)

### ขั้นตอนที่ 1: การเตรียมข้อมูล
- ตรวจสอบให้แน่ใจว่าพัสดุที่ถูกตีกลับมีการอัปเดตสถานะเป็น `Returned` ในระบบ OMS/ERP แล้ว (เช่น ผ่านการอัปเดต Bulk Tracking หรือการสแกนรับเข้า)
- ขอไฟล์รายงานการตีกลับ (Return Report) จากผู้ให้บริการขนส่ง (Flash, Kerry, J&T ฯลฯ)

### ขั้นตอนที่ 2: นำเข้าและตรวจสอบ
1. ไปที่เมนู **Tracking & Transport (จัดการขนส่ง)** > **Return Management (จัดการตีกลับ)**
2. คลิกปุ่ม **Import ตรวจสอบ**
3. เลือกไฟล์รายงานการตีกลับที่เตรียมไว้
4. ระบบจะประมวลผลไฟล์และเปลี่ยนเข้าสู่ "Verification Mode" (โหมดตรวจสอบ)

### ขั้นตอนที่ 3: ตรวจสอบผลลัพธ์
- **แถวสีเขียว**: รายการที่ยืนยันแล้วว่าถูกต้อง
- **แถวสีเหลือง (ยอดไม่ตรง)**: คลิกเพื่อดูส่วนต่าง
  - *ส่วนต่างเป็นบวก (+)*: ยอดในระบบ มากกว่า ยอดในไฟล์ (เช่น ขนส่งหักค่าธรรมเนียม)
  - *ส่วนต่างเป็นลบ (-)*: ยอดในระบบ น้อยกว่า ยอดในไฟล์
- **แถวสีแดง (ไม่พบข้อมูล)**:
  - ตรวจสอบว่าคำสั่งซื้อเหล่านี้มีอยู่ในระบบจริงหรือไม่
  - หากมีในระบบแต่สถานะไม่ใช่ 'Returned' ให้ทำการอัปเดตสถานะและลอง Import ใหม่

### ขั้นตอนที่ 4: การกระทบยอด (ในอนาคต)
- ยืนยันการรับเข้าสต็อก (Restock)
- การคืนเงินลูกค้า (กรณีชำระเงินแล้ว)
- ปิดเคสการตีกลับ
