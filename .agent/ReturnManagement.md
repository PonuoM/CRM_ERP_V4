# กฎเกณฑ์และขั้นตอนการทำงานของระบบจัดการการตีกลับ (Return Management)

## 1. ภาพรวม
โมดูลจัดการการตีกลับ (Return Management) ออกแบบมาเพื่อติดตาม ตรวจสอบ และกระทบยอดคำสั่งซื้อที่ถูกตีกลับ โดยเปรียบเทียบข้อมูลในระบบ (คำสั่งซื้อที่มีสถานะ 'Returned') กับรายงานภายนอก (เช่น รายงานการตีกลับจากขนส่ง) เพื่อความถูกต้องทางบัญชีและสต็อกสินค้า

## 2. กฎเกณฑ์หลัก (Core Rules)

### 2.1 สิทธิ์ของคำสั่งซื้อที่นำมาตรวจสอบ
- **ข้อกำหนดสถานะ**: เฉพาะคำสั่งซื้อที่มี `order_status = 'Returned'` (สถานะเป็น "ตีกลับ") เท่านั้นที่จะถูกนำมาเข้าสู่กระบวนการตรวจสอบ
- **แหล่งข้อมูล**: ดึงข้อมูลจากตาราง `orders` หลักในระบบ โดยรองรับการแสดงผลยอดเงินทั้งรูปแบบ `totalAmount` และ `total_amount` จาก API

### 2.2 ระบบแท็บ (Tabs System)
- **ตำแหน่ง**: แสดงเป็นแถวแยกต่างหากอยู่ใต้ส่วนหัวของหน้า (Header)
- **ยังไม่ตรวจสอบ (Pending)**: แสดงรายการคำสั่งซื้อที่มีสถานะ `Returned` แต่ยังไม่มีปรากฏในตาราง `order_returns` และไม่มีสถานะการตรวจสอบย้อนหลัง
  - มีปุ่ม **"จัดการ" (Manage)** ในแต่ละแถว เพื่อดำเนินการรายรายการ
- **ตรวจสอบแล้ว (Verified)**: แสดงรายการที่ถูกบันทึกลงในตาราง `order_returns` แล้ว

### 2.3 ฟีเจอร์ "จัดการ" (Manage Feature)
สำหรับรายการในแท็บ Pending ผู้ใช้สามารถกดปุ่ม "จัดการ" เพื่อดำเนินการกับคำสั่งซื้อนั้นๆ ได้ทันทีผ่าน Modal:
1. **แสดงข้อมูล**: แสดงรายการ Tracking Number ทั้งหมดที่เกี่ยวข้อง (สามารถระบุสถานะแยกตาม Tracking ได้)
2. **ดำเนินการรายบรรทัด**: สามารถเลือกสถานะได้อิสระแยกตามแต่ละ Tracking Number:
   - **รอดำเนินการ (Pending)**: ยังไม่ทำรายการ (ค่าเริ่มต้น)
   - **ตีกลับ (Returned)**: ยืนยันว่า Tracking นี้ถูกตีกลับ ต้องระบุยอดเงิน (Amount)
     - เมื่อบันทึก ระบบจะสร้างข้อมูลลงในตาราง `order_returns` (Status: returned) และย้ายรายการไปที่แท็บ Verified
   - **จัดส่งสำเร็จ (Delivered)**: สินค้านี้ส่งถึงลูกค้า (ไม่ถูกตีกลับ)
     - ระบบจะบันทึกข้อมูลลงในตาราง `order_returns` (Status: delivered) เพื่อเป็นหลักฐานว่าผ่านการตรวจสอบแล้วว่าส่งสำเร็จจริง

### 2.4 ข้อกำหนดของไฟล์นำเข้า (Import & Paste Requirements)
รองรับ 2 วิธีการนำเข้าข้อมูล:
1. **Import File**: รองรับไฟล์ Excel (`.xlsx`, `.xls`) หรือ CSV
2. **Paste Data (Excel Grid)**: การวางข้อมูลโดยตรงลงในตารางตรวจสอบ
   - **Download Template**: มีปุ่มดาวน์โหลดไฟล์ Template มาตรฐาน (`Return_Verification_Template.xlsx`)
   - **รูปแบบข้อมูล**:
     - **Column A**: Order Number / Tracking Number
     - **Column B**: Amount (ยอดเงิน)
     - **Column C**: Note (หมายเหตุ - Optional)

### 2.5 ตรรกะการจับคู่ (Matching Logic)
ระบบจะพยายามจับคู่แต่ละแถวจากไฟล์ที่ Import กับคำสั่งซื้อในระบบ (เฉพาะในแท็บ Pending) โดยใช้ลำดับความสำคัญดังนี้:
1. **จับคู่ด้วย Tracking Number**: ตรวจสอบว่าตัวระบุในไฟล์ตรงกับ `Tracking Number` ในระบบหรือไม่ (ทั้งจาก Tracking หลักและ Tracking ย่อยของแต่ละกล่อง)
   - หากตรงกับ Tracking ย่อย (`tracking_details`) ระบบจะบันทึก `sub_order_id` ที่เกี่ยวข้องด้วย
2. **จับคู่ด้วย Order ID**: ตรวจสอบว่าตัวระบุในไฟล์ตรงกับ `Order ID` หรือไม่
   - หากตัวระบุตรงกับ `sub_order_id` ของสินค้าภายในกล่อง ระบบจะบันทึก `sub_order_id` นั้น

## 3. ขั้นตอนการทำงาน (Workflow)

### ขั้นตอนที่ 1: การเตรียมข้อมูล
- ตรวจสอบให้แน่ใจว่าพัสดุที่ถูกตีกลับมีการอัปเดตสถานะเป็น `Returned` ในระบบ OMS/ERP แล้ว
- เตรียมข้อมูลจากขนส่ง:
  - **วิธีที่ 1 (แนะนำ)**: Download Template จากระบบ -> กรอกข้อมูล -> Copy ข้อมูล
  - **วิธีที่ 2**: ใช้ไฟล์รายงานจากขนส่งโดยตรง (ต้องมี Column Order/Tracking และ Amount)

### ขั้นตอนที่ 2: นำเข้าและตรวจสอบ
1. ไปที่เมนู **Tracking & Transport (จัดการขนส่ง)** > **Return Management (จัดการตีกลับ)**
2. เลือกวิธีการนำเข้า:
   - **Manual Manage**: กดปุ่ม "จัดการ" ที่รายการ เพื่อตรวจสอบทีละรายการ
   - **ปุ่ม "วางข้อมูล (Excel)"**:
     - หน้าต่างจะแสดงตาราง Grid (Columns A, B, C)
     - คลิกที่ตารางและกด `Ctrl+V` เพื่อวางข้อมูล
     - ดูตัวอย่างข้อมูลในตารางก่อนกด "ตรวจสอบข้อมูล"
   - **ปุ่ม "Import ไฟล์"**: เลือกไฟล์ Excel/CSV ที่มีอยู่

### ขั้นตอนที่ 3: ตรวจสอบผลลัพธ์
- **การดูรายละเอียด**: คลิกที่ **Order ID (สีน้ำเงิน)** เพื่อเปิดดูรายละเอียดคำสั่งซื้อ (Order Detail Modal) ได้ทันที
- **แถวสีเขียว**: รายการที่ยืนยันแล้วว่าถูกต้อง
- **แถวสีเหลือง (ยอดไม่ตรง)**: รายการที่จับคู่ได้แต่ยอดเงินไม่ตรง
- **แถวสีแดง (ไม่พบข้อมูล)**: รายการที่หาไม่เจอในระบบ

### ขั้นตอนที่ 4: การบันทึกข้อมูล (Save)
- เมื่อตรวจสอบข้อมูลเรียบร้อยแล้ว ให้กดปุ่ม **"บันทึกผลการตรวจสอบ"**
- ระบบจะบันทึกข้อมูลรายการที่ตรวจสอบแล้ว (Order ID, Sub Order ID, Returns Amount, Note) ลงในตาราง `order_returns`
- ใช้สำหรับเป็นหลักฐานการตรวจสอบและนำไปประมวลผลต่อ (เช่น การทำบัญชี หรือ Restock)

### ขั้นตอนที่ 5: การกระทบยอด (ในอนาคต)
- ยืนยันการรับเข้าสต็อก (Restock)
- การคืนเงินลูกค้า (กรณีชำระเงินแล้ว)
- ปิดเคสการตีกลับ

## 4. โครงสร้างฐานข้อมูล (Database Schema)

### ตาราง `order_returns`
ตารางสำหรับเก็บข้อมูลการตีกลับที่ผ่านการตรวจสอบแล้ว

```sql
CREATE TABLE `order_returns` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `sub_order_id` varchar(255) COLLATE utf8mb4_unicode_ci NOT NULL COMMENT 'รหัสคำสั่งซื้อย่อย (Main Key)',
  `return_amount` decimal(10,2) NOT NULL DEFAULT '0.00' COMMENT 'ยอดเงินที่ตรวจสอบจากไฟล์',
  `status` varchar(50) COLLATE utf8mb4_unicode_ci NOT NULL DEFAULT 'returned' COMMENT 'สถานะ: returned, delivered',
  `note` text COLLATE utf8mb4_unicode_ci COMMENT 'หมายเหตุ',
  `created_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `idx_sub_order_id` (`sub_order_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```
