# ระบบแจกรายชื่อ V2 (Customer Distribution V2)

## 1. ภาพรวม (Overview)
ระบบ "แจกรายชื่อ V2" ออกแบบมาเพื่อบริหารจัดการและกระจายรายชื่อลูกค้า (Leads/Customers) จาก "ถังกลาง" (Baskets) ไปยังพนักงานขาย (Telesale) เพื่อให้เกิดการติดต่อและสร้างยอดขาย รวมถึงมีความสามารถในการ "ดึงคืน" (Reclaim) รายชื่อกลับเข้าถังกลาง

## 2. องค์ประกอบหลัก (Core Components)

### 2.1 ถังลูกค้า (Baskets)
- **Concept**: ลูกค้าจะถูกจัดกลุ่มลงใน "ถัง" (Baskets) ตามเงื่อนไขต่างๆ (เช่น ลูกค้าใหม่, ลูกค้าเก่า 1-2 เดือน, Upsell ฯลฯ)
- **Configuration**: ข้อมูลถังถูกดึงมาจาก `basket_config.php`
- **Dashboard Baskets**: ชุดถังที่แสดงในตารางพนักงาน ใช้สำหรับดูภาพรวมว่าพนักงานแต่ละคนถือครองรายชื่อในถังหลักๆ เท่าไหร่

### 2.2 บทบาทผู้ใช้งาน (User Roles)
- **Supervisor/Admin**: ผู้ใช้งานที่จะเข้ามาทำการแจกรายชื่อ
- **Telesale**: พนักงานขายที่เป็น "ผู้รับ" รายชื่อ (Target Agents)

## 3. ขั้นตอนการแจกรายชื่อ (Distribution Workflow)

กระบวนการแจกรายชื่อแบ่งออกเป็นขั้นตอนดังนี้:

### ขั้นตอนที่ 1: ตั้งค่าการแจก (Distribution Settings)
1. **เลือกสถานะการแจก (Source Basket)**: เลือกถังต้นทางที่มีลูกค้าพร้อมแจก (Available Pool)
2. **ระบุจำนวนรวม (Total Amount)**: ใส่จำนวนลูกค้าทั้งหมดที่ต้องการแจกในรอบนี้
   - ระบบจะคำนวณจำนวนเฉลี่ยต่อคนให้อัตโนมัติ (Average per Person)
   - *ตัวอย่าง*: มีรายชื่อ 1000, เลือก 5 คน -> แจกคนละ 200

### ขั้นตอนที่ 2: เลือกพนักงานเป้าหมาย (Select Target Agents)
- แสดงตารางรายชื่อพนักงาน Telesale ทั้งหมด
- **ข้อมูลในตาราง**: แสดงจำนวนลูกค้าที่พนักงาน "ถือครองอยู่" ในปัจจุบัน แยกรายถัง (Dashboard Baskets)
- **การเลือก**: ติ๊กเลือกพนักงานที่ต้องการให้ได้รับงาน (สามารถ Select All ได้)

### ขั้นตอนที่ 3: ดูตัวอย่างและตรวจสอบ (Preview & Logic)
- กดปุ่ม **"ดูตัวอย่างก่อนแจก" (Preview)** ระบบจะจำลองการแจกรายชื่อโดยใช้ **Smart Allocation Logic**:
   1. **Round-Robin (Pruning)**:
      - วนแจกให้พนักงานทีละคน
      - **Logic ใหม่**: ใช้ตาราง `customer_assign_check` เพื่อบันทึกประวัติว่าลูกค้าเคยอยู่กับใครในรอบปัจจุบัน
      - หากเจอประวัติซ้ำ -> ข้ามพนักงานคนนั้น (Pruning)
      - หากข้ามจนครบทุกคนแล้วยังลงไม่ได้ -> ถือว่า "วนซ้ำ" (Shortfall)
   2. **Previous Owner Check**: (Logic เดิมถูกรวมเข้าไปใน Pruning แล้ว)
   3. **Fallback Loop**: หากแจกไม่ครบเนื่องจากติดเงื่อนไขซ้ำ ระบบจะแจ้งเตือน (Shortfall Alert) ให้ผู้ใช้ตัดสินใจว่าจะหาคนใหม่มาเติมหรือไม่

### ขั้นตอนที่ 4: ยืนยันการแจก (Execute)
- เมื่อกดแจก ระบบจะเรียก API `Distribution/index.php?action=distribute`
- **ผลลัพธ์**: ลูกค้าจะถูกย้ายจากถังกลาง และบันทึกประวัติลง `customer_assign_check`

## 4. ระบบการดึงคืน (Reclaim System)

ฟีเจอร์สำหรับดึงรายชื่อลูกค้าจากมือพนักงานกลับเข้าถังกลาง

### วิธีใช้งาน
1. กดที่ปุ่ม **"ดึงคืน" (Reclaim)** ในแถวของพนักงานที่ต้องการจัดการ
2. **Modal ดึงคืน**:
   - ระบบจะแสดงรายการถังต่างๆ ที่พนักงานคนนั้นถือครองอยู่
   - ช่องกรอกจำนวน: ระบุจำนวนที่ต้องการดึงคืนจากแต่ละถัง
   - *ข้อจำกัด*: สามารถดึงคืนได้เฉพาะถังที่มีการผูกกับ Distribution Basket เท่านั้น (Linked Basket)
3. **ยืนยัน**: เมื่อกดยืนยัน ระบบจะปลด `agent_id` ของลูกค้าเหล่านั้นออก และย้ายกลับเข้าถังกลาง

## 5. ระบบล้างรอบ (Manual Round Reset) [NEW]

ฟีเจอร์สำหรับ "ล้างประวัติการถือครอง" เพื่อให้สามารถแจกซ้ำพนักงานเดิมได้อีกครั้ง (เริ่มนับรอบใหม่)

### วิธีใช้งาน
1. กดปุ่ม **"Manual Reset"** มุมขวาบน
2. **ค้นหา**: ระบุจำนวนครั้งที่ลูกค้าถูกแจกไปแล้ว (Target Count) เช่น "แจกไปแล้ว 1 ครั้ง"
3. **ผลลัพธ์**: ตารางแสดงรายชื่อลูกค้าที่ตรงเงื่อนไข พร้อมระบบ **Pagination** (เปลี่ยนหน้าทีละ 50 รายการ)
    - **ดูประวัติ**: กดไอคอนรูปตา (Eye Icon) เพื่อดูประวัติการแจก (ใครรับไปเมื่อไหร่)
4. **Action**:
   - **Reset Selected**: เลือกติ๊กถูกรายบุคคลแล้วกด Reset (ยืนยันด้วย Modal สีส้ม)
   - **Reset All**: กดปุ่มแดงเพื่อล้าง *ทั้งหมด* ตามจำนวนที่ค้นหาเจอ (ยืนยันด้วย Modal สีแดง)

## 6. สรุปผลการแจก (Summary Modal) [NEW]
หลังการแจกระบบจะแสดง Modal สรุปผล:
- **ยอดรวม**: สำเร็จ / ล้มเหลว
- **รายพนักงาน**: ตารางแสดงยอดที่พนักงานแต่ละคนได้รับจริง
- **Retry Loop**: หากแจกไม่ครบโควต้า (Shortfall) จะมีปุ่ม **"แจกเพิ่มส่วนที่ขาด"** เพื่อให้ระบบค้นหาลูกค้าใหม่มาเติมให้ครบโดยอัตโนมัติ

## 7. การทำงานเชิงเทคนิค (Technical Implementation)

### 7.1 Main Component
- **File**: `pages/CustomerDistributionV2.tsx`
- **State Management**: ใช้ `useState` และ `useEffect` จัดการข้อมูล Baskets, Agents, และ Customers
- **UI Components**: ใช้ Modal ที่เขียนขึ้นเองแทน `window.confirm` เพื่อความสวยงาม (ConfirmationModal)

### 7.2 Key API Endpoints
- **GET** `basket_config.php`: ดึงการตั้งค่าถัง
- **POST** `Distribution/index.php`: `distribute` (Logic การแจกใหม่)
- **POST** `Distribution/reset.php`:
  - `get_candidates`: ดึงรายชื่อสำหรับ Reset (support pagination)
  - `manual_reset`: สั่งล้างข้อมูล (`mode='selected'` หรือ `'all'`)
  - `get_assign_history`: ดึงประวัติการแจกของลูกค้า

### 7.3 Data Logic
- **Round Robin Logic**:
  - ใช้ตาราง `customer_assign_check` (เก็บประวัติการแจกในรอบปัจจุบัน)
  - ใช้ฟิลด์ `current_round` ในตาราง `customers` (นับรอบการวน)
  - **Pruning**: ก่อนแจกจะเช็ค `customer_assign_check` ว่าเคยแจกพนักงานคนนี้ในรอบ `current_round` หรือไม่
  - **Auto Increment**: เมื่อแจกครบทุกคน (หรือครบตามจำนวน Sale), ระบบจะเคลียร์ `customer_assign_check` และ +1 ให้ `current_round` อัตโนมัติ

### 7.4 Database Schema Changes
- **Tables**: `customer_assign_check`
- **Columns**: `customers.current_round` (INT DEFAULT 1)

## 8. ข้อควรระวัง (Notes)
- **Upsell Basket**: ถัง Upsell มักจะมี Logic พิเศษที่เชื่อมโยงกับถังหลัก
- **Concurrency**: ข้อมูลจำนวนลูกค้า "พร้อมแจก" อาจเปลี่ยนแปลงได้ถ้ามี Admin หลายคนทำงานพร้อมกัน
