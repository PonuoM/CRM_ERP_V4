    <h1>Database Sync</h1>
    <p class="note">
      หน้านี้ใช้รันคำสั่ง npm สำหรับซิงค์ฐานข้อมูล:
      <code>db:pull</code>, <code>db:push</code>, <code>db:seed</code>
    </p>

    <div id="status"></div>

    <div class="buttons">
      <button type="button" data-command="db-pull">
        npm run db:pull
      </button>
      <button type="button" data-command="db-push">
        npm run db:push
      </button>
      <button type="button" data-command="db-seed">
        npm run db:seed
      </button>
    </div>

    <pre id="output"></pre>

    <script>
      const buttons = document.querySelectorAll('button[data-command]');
      const outputEl = document.getElementById('output');
      const statusEl = document.getElementById('status');

      let currentLogId = null;
      let polling = false;

      function setButtonsDisabled(disabled) {
        buttons.forEach((btn) => {
          btn.disabled = disabled;
        });
      }

      async function startCommand(key, label) {
        setButtonsDisabled(true);
        outputEl.textContent = '';
        statusEl.textContent = 'กำลังรันคำสั่ง: ' + label;

        try {
          const res = await fetch(
            'database_sync.php?action=start&command=' + encodeURIComponent(key),
            {
              method: 'POST',
              headers: { 'X-Requested-With': 'XMLHttpRequest' },
            },
          );

          const data = await res.json();
          if (!data.ok) {
            statusEl.textContent = 'เริ่มคำสั่งไม่สำเร็จ: ' + (data.error || '');
            setButtonsDisabled(false);
            return;
          }

          currentLogId = data.logId;
          polling = true;
          pollLog();
        } catch (e) {
          console.error(e);
          statusEl.textContent = 'เกิดข้อผิดพลาดในการเริ่มคำสั่ง';
          setButtonsDisabled(false);
        }
      }

      async function pollLog() {
        if (!polling || !currentLogId) {
          return;
        }

        try {
          const res = await fetch(
            'database_sync.php?action=read&log=' +
              encodeURIComponent(currentLogId) +
              '&_t=' +
              Date.now(),
            {
              method: 'GET',
              headers: { 'X-Requested-With': 'XMLHttpRequest' },
              cache: 'no-store',
            },
          );

          if (!res.ok) {
            // ถ้า server ยังไม่สร้างไฟล์ log ให้รอสักพักแล้วลองใหม่
            setTimeout(pollLog, 1000);
            return;
          }

          const data = await res.json();
          if (!data.ok) {
            setTimeout(pollLog, 1000);
            return;
          }

          outputEl.textContent = data.log || '';
          outputEl.scrollTop = outputEl.scrollHeight;

          // ยังไม่รู้ว่าเสร็จหรือยัง เลย polling ต่อไปทุก 1 วิ
          setTimeout(pollLog, 1000);
        } catch (e) {
          console.error(e);
          statusEl.textContent = 'เกิดข้อผิดพลาดระหว่างอ่าน log';
          polling = false;
          setButtonsDisabled(false);
        }
      }

      buttons.forEach((btn) => {
        btn.addEventListener('click', () => {
          const key = btn.getAttribute('data-command');
          const label = btn.textContent.trim();
          startCommand(key, label);
        });
      });
    </script>
  </body>
  </html>
