# เอกสารประกอบระบบ Page_DB

## ภาพรวม

โฟลเดอร์ `api/Page_DB` ประกอบด้วยไฟล์ต่างๆ ที่ใช้ในการจัดการข้อมูลเพจและผู้ใช้ในระบบ CRM โดยมีการทำงานหลักๆ ดังนี้

## ไฟล์ SQL สำหรับสร้างและอัปเดตโครงสร้างฐานข้อมูล

### 1. 20251014_UpdatePagesTable.sql
- **วัตถุประสงค์**: อัปเดตโครงสร้างตาราง `pages` ด้วยฟิลด์ที่จำเป็น
- **ฟังก์ชันหลัก**:
  - เพิ่มคอลัมน์ `page_id` (VARCHAR(255)) สำหรับเก็บ ID ของเพจ
  - เพิ่มคอลัมน์ `still_in_list` (TINYINT) บอกว่าเพจยังแสดงในรายการหรือไม่ (1=แสดง, 0=ซ่อน)
  - เพิ่มคอลัมน์ `user_count` (INT) จำนวนผู้ใช้ที่กำหนดให้กับเพจ
  - เพิ่มคอลัมน์ `created_at` และ `updated_at` สำหรับบันทึกเวลา
  - สร้าง index สำหรับปรับปรุงประสิทธิภาพการค้นหา
- **เงื่อนไขพิเศษ**: ตรวจสอบว่าคอลัมน์และ index มีอยู่แล้วหรือไม่ก่อนสร้าง

### 2. 20251020_create_page_database_tables.sql
- **วัตถุประสงค์**: สร้างตารางสำหรับเก็บข้อมูลสถิติเพจและข้อมูลการมีส่วนร่วม
- **ฟังก์ชันหลัก**:
  - สร้างตาราง `page_stats_batch` สำหรับติดตามการนำเข้าข้อมูลเป็นชุด (batch)
  - สร้างตาราง `page_stats_log` สำหรับเก็บข้อมูลสถิติเพจ
  - สร้างตาราง `page_engagement_batch` สำหรับติดตามการนำเข้าข้อมูลการมีส่วนร่วม
  - สร้างตาราง `page_engagement_log` สำหรับเก็บข้อมูลการมีส่วนร่วมของเพจ
  - เพิ่ม foreign key constraints และ index ต่างๆ
- **เงื่อนไขพิเศษ**: มีการตรวจสอบและสร้างคอลัมน์/index แบบมีเงื่อนไข พร้อมทั้งลบคอลัมน์ `created_at` จากตาราง log

### 3. 20251021_create_page_user_table.sql
- **วัตถุประสงค์**: สร้างตารางสำหรับเก็บข้อมูลความสัมพันธ์ระหว่างผู้ใช้และเพจ
- **ฟังก์ชันหลัก**:
  - สร้างตาราง `page_user` เก็บข้อมูลผู้ใช้เพจ
  - สร้างตาราง `page_list_user` เก็บความสัมพันธ์ระหว่างเพจและผู้ใช้
  - เพิ่ม unique constraint เพื่อป้องกันข้อมูลซ้ำ
- **เงื่อนไขพิเศษ**: ไม่สร้าง foreign key constraints ชั่วคราวเพื่อหลีกเลี่ยงปัญหาความเข้ากันได้ของข้อมูล

## ไฟล์ PHP สำหรับจัดการข้อมูล

### 4. delete_batches.php
- **วัตถุประสงค์**: ลบข้อมูล batch และ log ที่เกี่ยวข้อง
- **ฟังก์ชันหลัก**:
  - รับข้อมูล JSON ที่มีรายการ batch IDs
  - ลบข้อมูลจากตาราง `page_stats_log` และ `page_stats_batch`
  - ใช้ transaction เพื่อความปลอดภัย
- **เงื่อนไขการใช้งาน**:
  - ต้องส่งข้อมูลแบบ POST พร้อม batch IDs ในรูปแบบ JSON
  - ต้องมี batchIds ที่เป็น array และไม่ว่างเปล่า

### 5. env_manager.php
- **วัตถุประสงค์**: จัดการตัวแปรสภาพแวดล้อม (environment variables)
- **ฟังก์ชันหลัก**:
  - GET: ดึงข้อมูลตัวแปรสภาพแวดล้อมทั้งหมดหรือเฉพาะตัวแปรที่ระบุ
  - POST: สร้างหรืออัปเดตตัวแปรสภาพแวดล้อม
  - PUT: อัปเดตตัวแปรสภาพแวดล้อมที่มีอยู่แล้ว
  - DELETE: ลบตัวแปรสภาพแวดล้อม
- **เงื่อนไขการใช้งาน**:
  - ต้องมี key และ value สำหรับการสร้าง/อัปเดต
  - ต้องมี key สำหรับการลบ

### 6. get_date_ranges.php
- **วัตถุประสงค์**: ดึงข้อมูลช่วงวันที่ที่มีอยู่ในระบบ
- **ฟังก์ชันหลัก**:
  - ดึงข้อมูลจากตาราง `page_stats_batch` และ `page_engagement_batch`
  - แยกวันที่จากช่วงวันที่ที่มีอยู่
  - สามารถกรองตาม source (page_engagement, page_stats, หรือ all)
- **เงื่อนไขการใช้งาน**:
  - รับพารามิเตอร์ source เพื่อกรองข้อมูล
  - แปลงรูปแบบวันที่จาก API ให้เป็น YYYY-MM-DD

### 7. page_engagement_upload.php
- **วัตถุประสงค์**: นำเข้าข้อมูลการมีส่วนร่วมของเพจ
- **ฟังก์ชันหลัก**:
  - สร้าง batch record ในตาราง `page_engagement_batch`
  - บันทึกข้อมูลการมีส่วนร่วมในตาราง `page_engagement_log`
  - แปลงรูปแบบวันที่จาก DD/MM/YYYY เป็น YYYY-MM-DD
  - อัปเดตสถานะ batch (processing -> completed/failed)
- **เงื่อนไขการใช้งาน**:
  - ต้องส่งข้อมูลแบบ POST พร้อม dateRange และ engagementData
  - ใช้ transaction เพื่อความปลอดภัย

### 8. page_stats_import.php
- **วัตถุประสงค์**: นำเข้าข้อมูลสถิติเพจ
- **ฟังก์ชันหลัก**:
  - สร้าง batch record ในตาราง `page_stats_batch`
  - บันทึกข้อมูลสถิติในตาราง `page_stats_log`
  - ใช้ ON DUPLICATE KEY UPDATE สำหรับอัปเดตข้อมูลซ้ำ
- **เงื่อนไขการใช้งาน**:
  - ต้องส่งข้อมูลแบบ POST พร้อม dateRange, pages, viewMode และ apiData
  - ต้องมีฟิลด์ที่จำเป็นครบถ้วน

### 9. sync_page_list_user.php
- **วัตถุประสงค์**: ซิงค์ข้อมูลความสัมพันธ์ระหว่างเพจและผู้ใช้
- **ฟังก์ชันหลัก**:
  - รับข้อมูลเพจและผู้ใช้จาก API
  - อัปเดตข้อมูลที่มีอยู่แล้วในฐานข้อมูล
  - เพิ่มข้อมูลใหม่ที่ไม่มีในฐานข้อมูล
  - 标记 ผู้ใช้ที่ไม่มีใน API ว่า still_in_list = 0
- **เงื่อนไขการใช้งาน**:
  - ต้องส่งข้อมูลแบบ POST พร้อม pages และ companyId
  - ใช้ transaction เพื่อความปลอดภัย

### 10. sync_page_users.php
- **วัตถุประสงค์**: ซิงค์ข้อมูลผู้ใช้เพจ
- **ฟังก์ชันหลัก**:
  - รวบรวมข้อมูลผู้ใช้จากทุกเพจ
  - นับจำนวนเพจที่ผู้ใช้เกี่ยวข้องด้วย
  - อัปเดตข้อมูลผู้ใช้ที่มีอยู่แล้ว
  - เพิ่มผู้ใช้ใหม่
- **เงื่อนไขการใช้งาน**:
  - นำเข้าผู้ใช้ทุกคนโดยไม่สนใจสถานะ (รวมถึงผู้ใช้ที่มีสถานะ "removed")
  - ต้องส่งข้อมูลแบบ POST พร้อม pages และ companyId

### 11. sync_pages.php
- **วัตถุประสงค์**: ซิงค์ข้อมูลเพจ
- **ฟังก์ชันหลัก**:
  - รับข้อมูลเพจจาก API
  - ตั้งค่า still_in_list = 0 สำหรับเพจทั้งหมดในบริษัท
  - อัปเดต/เพิ่มเพจจาก API และตั้งค่า still_in_list = 1
  - อัปเดตข้อมูลต่างๆ เช่น ชื่อ, แพลตฟอร์ม, สถานะการใช้งาน, จำนวนผู้ใช้
- **เงื่อนไขการใช้งาน**:
  - ต้องส่งข้อมูลแบบ POST พร้อม pages และ companyId
  - ใช้ transaction เพื่อความปลอดภัย

## โครงสร้างข้อมูลหลัก

### ตาราง pages
- `page_id`: ID ของเพจ
- `name`: ชื่อเพจ
- `platform`: แพลตฟอร์ม (เช่น Facebook, Line)
- `company_id`: ID ของบริษัท
- `active`: สถานะการใช้งาน (0/1)
- `still_in_list`: ยังแสดงในรายการหรือไม่ (0/1)
- `user_count`: จำนวนผู้ใช้

### ตาราง page_user
- `user_id`: อ้างอิงถึง ID ผู้ใช้ในระบบ
- `page_user_id`: ID ผู้ใช้จากระบบภายนอก
- `page_user_name`: ชื่อผู้ใช้
- `page_count`: จำนวนเพจที่เกี่ยวข้อง

### ตาราง page_list_user
- `page_id`: ID ของเพจ
- `page_user_id`: ID ผู้ใช้จากตาราง page_user
- `status`: สถานะของผู้ใช้
- `still_in_list`: ยังอยู่ในรายการหรือไม่ (0/1)

### ตารางสถิติและการมีส่วนร่วม
- `page_stats_batch`/`page_engagement_batch`: เก็บข้อมูล batch การนำเข้า
- `page_stats_log`/`page_engagement_log`: เก็บข้อมูลสถิติและการมีส่วนร่วมรายวัน

## ข้อควรระวัง

1. ทุกการดำเนินการที่เปลี่ยนแปลงข้อมูลใช้ transaction เพื่อความปลอดภัย
2. มีการตรวจสอบความถูกต้องของข้อมูลก่อนดำเนินการ
3. มีการจัดการ error และ rollback transaction เมื่อเกิดข้อผิดพลาด
4. ไฟล์ SQL มีการตรวจสอบว่ามีโครงสร้างอยู่แล้วหรือไม่ก่อนสร้างใหม่