with `users_ts` as (select `u`.`id` AS `id`,`u`.`first_name` AS `first_name`,`u`.`role` AS `role`,(cast(replace(replace(`u`.`phone`,'-',''),' ','') as char charset utf8mb4) collate utf8mb4_unicode_ci) AS `phone0` from `mini_erp`.`users` `u` where (`u`.`role` in ('Telesale','Supervisor Telesale'))), `calls` as (select `uts`.`id` AS `user_id`,(cast(date_format(`ocl`.`timestamp`,'%Y-%m') as char charset utf8mb4) collate utf8mb4_unicode_ci) AS `month_key`,count(0) AS `total_calls`,sum((case when (`ocl`.`duration` >= 40) then 1 else 0 end)) AS `connected_calls`,round((sum(`ocl`.`duration`) / 60),2) AS `total_minutes` from (`mini_erp`.`onecall_log` `ocl` join `users_ts` `uts` on(((cast((case when (regexp_replace(coalesce(`ocl`.`phone_telesale`,''),'[^0-9]+','') like '66%') then concat('0',substr(regexp_replace(coalesce(`ocl`.`phone_telesale`,''),'[^0-9]+',''),(case when (substr(regexp_replace(coalesce(`ocl`.`phone_telesale`,''),'[^0-9]+',''),3,1) = '0') then 4 else 3 end))) when (regexp_replace(coalesce(`ocl`.`phone_telesale`,''),'[^0-9]+','') like '0%') then regexp_replace(coalesce(`ocl`.`phone_telesale`,''),'[^0-9]+','') else concat('0',regexp_replace(coalesce(`ocl`.`phone_telesale`,''),'[^0-9]+','')) end) as char charset utf8mb4) collate utf8mb4_unicode_ci) = `uts`.`phone0`))) group by `uts`.`id`,date_format(`ocl`.`timestamp`,'%Y-%m')), `attendance` as (select `uts`.`id` AS `user_id`,(cast(date_format(`a`.`work_date`,'%Y-%m') as char charset utf8mb4) collate utf8mb4_unicode_ci) AS `month_key`,sum(`a`.`attendance_value`) AS `working_days` from (`mini_erp`.`user_daily_attendance` `a` join `users_ts` `uts` on((`uts`.`id` = `a`.`user_id`))) group by `uts`.`id`,date_format(`a`.`work_date`,'%Y-%m')), `months` as (select `calls`.`user_id` AS `user_id`,`calls`.`month_key` AS `month_key` from `calls` union select `attendance`.`user_id` AS `user_id`,`attendance`.`month_key` AS `month_key` from `attendance`) select (`m`.`month_key` collate utf8mb4_unicode_ci) AS `month_key`,`uts`.`id` AS `user_id`,`uts`.`first_name` AS `first_name`,`uts`.`role` AS `role`,`uts`.`phone0` AS `phone`,coalesce(`att`.`working_days`,0) AS `working_days`,coalesce(`c`.`total_minutes`,0) AS `total_minutes`,coalesce(`c`.`connected_calls`,0) AS `connected_calls`,coalesce(`c`.`total_calls`,0) AS `total_calls`,round((coalesce(`c`.`total_minutes`,0) / nullif(coalesce(`att`.`working_days`,0),0)),2) AS `minutes_per_workday` from (((`months` `m` join `users_ts` `uts` on((`uts`.`id` = `m`.`user_id`))) left join `calls` `c` on(((`c`.`user_id` = `m`.`user_id`) and (`c`.`month_key` = `m`.`month_key`)))) left join `attendance` `att` on(((`att`.`user_id` = `m`.`user_id`) and (`att`.`month_key` = `m`.`month_key`)))) order by `m`.`month_key` desc,`uts`.`id`
